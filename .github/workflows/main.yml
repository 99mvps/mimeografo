name: fly deploy

on:
  pull_request:
    types:
      - closed
    branches:
      - main
    condition:
      - github.event.pull_request.merged == true

jobs:
  deploy:
    name: deploy app
    runs-on: ubuntu-latest
    steps:
      - name: determine current directory
        id: dir
        run: echo "directory=$(pwd)" >> "$GITHUB_OUTPUT"

      - name: deploy frontend
        if: ${{ steps.dir.outputs.directory }}/frontend
        steps:
          - name: Checkout code
            uses: actions/checkout@v2
          - uses: superfly/flyctl-actions/setup-flyctl@v1
          - run: flyctl deploy --remote-only
            env:
              FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: deploy service
        if: ${{ steps.dir.outputs.directory }}/service
        steps:
          - name: Checkout code
            uses: actions/checkout@v2
          - uses: superfly/flyctl-actions/setup-flyctl@v1
          - run: flyctl deploy --remote-only
            env:
              FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

